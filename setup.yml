---
  # This playbook is executed by Vagrant or  Ansible Tower to configure
  # new hosts once they have been provisioned.

  # Generate ETCD Discovery Tokens
  - name: Setup ETCD Discovery
    hosts: all
    become_method: sudo
    vars_files:
      - config.yml
    roles:
      - etcd-discovery

  # Perform Routine Tasks on Meteor Hosts
  #   - Update Packages
  #   - Add Meteor EPEL
  #   - Sync Chronyd
  #   - Start ETCD Clustering
  - name: Prepare Meteor Hosts
    hosts: tuxlab-meteor:security_group_meteor
    become_method: sudo
    vars:
      etcd_interface: eth1
    vars_files:
      - config.yml
    roles:
      - centos
      - chronyd
      - ssl
      - etcd

  # Configure Swarm Engine
  #    - Update Atomic
  #    - Create and Sign SSL Certificates
  #    - Configure ETCD
  #    - Configure Docker
  - name: Configure Swarm Engine
    hosts: tuxlab-swarm-host:tuxlab-swarm-manager:security_group_docker_host:security_group_docker_manager
    become_method: sudo
    gather_facts: no
    vars_files:
      - config.yml
    vars:
      etcd_interface: enp0s8
    roles:
      - atomic
      - ssl
      - etcd
      - dockerengine

  # Configure Swarm Engine
  #    - Update Atomic
  #    - Create and Sign SSL Certificates
  #    - Configure ETCD
  #    - Configure Docker
  - name: Configure Swarm Hosts
    hosts: tuxlab-swarm-host:security_group_docker_host
    become_method: sudo
    gather_facts: no
    vars_files:
      - config.yml
    roles:
      - dockerhost
      - tuxlab-labvm

  - name: Configure Swarm Manager
    hosts: tuxlab-swarm-manager:security_group_docker_manager
    become_method: sudo
    gather_facts: no
    vars_files:
      - config.yml
    roles:
      - dockerswarm
      - tuxlab-dns

  - name: Configure Swarm Hosts
    hosts: tuxlab-swarm-host:security_group_docker_host
    become_method: sudo
    gather_facts: no
    vars_files:
      - config.yml
    roles:
      - tuxlab-proxy
      - tuxlab-session-daemon

  - name: Configure Meteor Applications
    hosts: tuxlab-meteor:security_group_meteor
    become_method: sudo
    vars_files:
      - config.yml
    roles:
      - meteor
      - tuxlab-app

  # Install Mongo Client for Logging
  - name: Install mongo client on tower
    hosts: security_group_tower
    become_method: sudo
    roles:
      - tuxlab-mongo

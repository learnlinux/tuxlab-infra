---
  # This playbook is executed by Vagrant or  Ansible Tower to configure
  # new hosts once they have been provisioned.

  - name: Setup ETCD
    hosts: all
    gather_facts: no
    vars_files:
      - config.yml
    roles:
      - etcd-cluster
      - letsencrypt

  - name: Prepare Meteor Hosts
    hosts: tuxlab-meteor:security_group_meteor
    become: yes
    become_method: sudo
    vars:
      ansible_ssh_user: "{{ 'ec2-user' if 'security_group_meteor' in group_names else 'vagrant' }}"

      etcd_user: etcd
      etcd_dir: "/usr/bin"
      etcd_cmd: "{{ etcd_dir }}/etcd"
      etcd_data_dir: "/var/lib/etcd"
    vars_files:
      - config.yml
    roles:
      - centos
      - chronyd
      - etcd

  - name: Bootstrap coreos
    hosts: tuxlab-swarm-host:tuxlab-swarm-manager:security_group_docker_host:security_group_docker_manager
    gather_facts: no
    vars_files:
      - config.yml
    vars:
      ansible_ssh_user: core
      ansible_python_interpreter: "/home/core/bin/python"

      etcd_user: etcd
      etcd_dir: "/usr/bin"
      etcd_cmd: "{{ etcd_dir }}/etcd2"
      etcd_data_dir: "/var/lib/etcd2"
    roles:
      - defunctzombie.coreos-bootstrap

  - name: Configure SSH Connection to Swarm Hosts
    hosts: tuxlab-swarm-host:security_group_docker_host
    gather_facts: no
    vars_files:
      - config.yml
    roles:
      - ssh-config

  - name: Generate certs
    hosts: tuxlab-swarm-host:tuxlab-swarm-manager:security_group_docker_host:security_group_docker_manager
    gather_facts: no
    vars_files:
      - config.yml
    roles:
      - tls-ca

  - name: Configure Swarm Engine
    hosts: tuxlab-swarm-host:tuxlab-swarm-manager:security_group_docker_host:security_group_docker_manager
    gather_facts: no
    vars_files:
      - config.yml
    vars:
      ansible_ssh_user: core
      ansible_python_interpreter: "/home/core/bin/python"

      etcd_user: etcd
      etcd_dir: "/usr/bin"
      etcd_cmd: "{{ etcd_dir }}/etcd2"
      etcd_data_dir: "/var/lib/etcd2"
    roles:
      - docker-tls
      - coreos
      - timesyncd
      - etcd
      - dockerengine

  - name: Configure Swarm Hosts
    hosts: tuxlab-swarm-host:security_group_docker_host
    become: yes
    become_method: sudo
    gather_facts: no
    vars_files:
      - config.yml
    vars:
      ansible_ssh_user: core
      ansible_python_interpreter: "/home/core/bin/python"
    roles:
      - dockerhost
      - tuxlab-sshd
      - tuxlab-proxy

  - name: Configure Swarm Manager
    hosts: tuxlab-swarm-manager:security_group_docker_manager
    gather_facts: no
    vars_files:
      - config.yml
    vars:
      ansible_ssh_user: core
      ansible_python_interpreter: "/home/core/bin/python"
    roles:
      - dockerswarm
      - etcd-auth
      - tuxlab-dns

  - name: Configure Meteor Applications
    hosts: tuxlab-meteor:security_group_meteor
    become: yes
    become_method: sudo
    vars:
      ansible_ssh_user: "{{ 'ec2-user' if 'security_group_meteor' in group_names  else 'vagrant' }}"
    vars_files:
      - config.yml
    roles:
      - ssl-distribution
      - nodejs
      - meteor
      - tuxlab-app

  - name: Run Meteor Tests
    hosts: tuxlab-meteor:security_group_meteor
    vars:
      ansible_ssh_user: "{{ 'ec2-user' if 'security_group_meteor' in group_names else 'vagrant' }}"
    vars_files:
      - config.yml
    tasks:
     - include: tests.yml

  - name: Run Tests
    include: tests.yml
